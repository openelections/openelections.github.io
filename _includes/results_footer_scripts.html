<script src="{{ site.baseurl }}/js/states.js"></script>
<script src="{{ site.baseurl }}/js/results.js"></script>
<script src="{{ site.baseurl }}/js/github-integration.js"></script>
<script>
$(function() {
  /**
   * Get parameter from browser querystring.
   * Based on http://css-tricks.com/snippets/javascript/get-url-variables/
   */
  function getQueryVariable(variable, query) {
     query = query || window.location.search.substring(1);
     var vars = query.split("&");
     var i, pair;

     if (!query) {
       return false;
     }

     for (i=0; i<vars.length; i++) {
        pair = vars[i].split("=");
        if (pair[0] == variable) {
          return pair[1] ? pair[1]: true;
        }
     }
     return false;
  }

  var app = new openelex.ResultsApp('#results-container', {
    root: "/results/",
    dataRoot: "/data",
    statusJSON: '/data/state_status.json',
    sidebarEl: '#sidebar',
    showElectionCountLegend: !getQueryVariable('hidecountlegend',
      window.location.hash.split('?')[1])
  });

  // Initialize GitHub integration
  const githubAPI = new GitHubAPI({
    org: 'openelections',
    cacheTimeout: 5 * 60 * 1000 // 5 minutes
  });

  const repoDisplay = new StateRepositoryDisplay('github-repos', githubAPI);

  // Listen for state changes and update GitHub repo display
  if (typeof Backbone !== 'undefined') {
    Backbone.on('state', function(state) {
      if (repoDisplay && state) {
        // Add a small delay to let the page settle
        setTimeout(() => {
          repoDisplay.displayStateRepositories(state);
        }, 100);
      }
    });
  }
});
</script>
