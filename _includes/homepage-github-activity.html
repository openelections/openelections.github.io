<!-- Homepage GitHub Activity Initialization -->
<script>
// Simple homepage GitHub activity
document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('activity-loading')) {
    loadHomepageGitHubActivity();
  }
});

async function loadHomepageGitHubActivity() {
  try {
    // Simple fetch of recent repositories
    const response = await fetch('https://api.github.com/orgs/openelections/repos?sort=updated&per_page=100');
    if (!response.ok) {
      throw new Error(`GitHub API error: ${response.status}`);
    }
    const repos = await response.json();
    
    // Fetch recent commits from the most active repositories
    const recentCommits = await fetchRecentCommits(repos.slice(0, 10));
    
    // Update stats
    updateHomepageStats(repos, recentCommits);
    
    // Show recent activity
    displayHomepageActivity(recentCommits);
    
    // Hide loading, show content
    document.getElementById('activity-loading').classList.add('d-none');
    document.getElementById('activity-content').classList.remove('d-none');
    
  } catch (error) {
    console.error('Failed to load homepage GitHub activity:', error);
    document.getElementById('activity-loading').innerHTML = `
      <div class="alert alert-warning">
        <h6><i class="fab fa-github me-2"></i>GitHub Activity</h6>
        <p class="mb-2">Unable to load recent activity. Please try again later.</p>
        <a href="https://github.com/openelections" class="btn btn-outline-primary btn-sm" target="_blank">
          <i class="fab fa-github me-1"></i> View on GitHub
        </a>
      </div>
    `;
  }
}

// Function to fetch recent commits from multiple repositories
async function fetchRecentCommits(repos) {
  const commits = [];
  
  // Fetch commits from the most recently updated repositories
  for (const repo of repos.slice(0, 8)) {
    try {
      const commitsResponse = await fetch(`https://api.github.com/repos/openelections/${repo.name}/commits?per_page=3`);
      if (commitsResponse.ok) {
        const repoCommits = await commitsResponse.json();
        repoCommits.forEach(commit => {
          commits.push({
            ...commit,
            repository: repo
          });
        });
      }
    } catch (error) {
      console.warn(`Failed to fetch commits for ${repo.name}:`, error);
    }
  }
  
  // Sort all commits by date and return the most recent
  return commits
    .sort((a, b) => new Date(b.commit.author.date) - new Date(a.commit.author.date))
    .slice(0, 15);
}

function updateHomepageStats(repos, commits) {
  // Update repository count
  const totalReposElement = document.getElementById('total-repos');
  if (totalReposElement) {
    totalReposElement.textContent = repos.length;
  }
  
  // Update recent commits count
  const recentCommitsElement = document.getElementById('recent-commits');
  if (recentCommitsElement) {
    recentCommitsElement.textContent = commits.length;
  }
  
  // Update active contributors (unique commit authors)
  const contributorsElement = document.getElementById('active-contributors');
  if (contributorsElement) {
    const uniqueAuthors = new Set(commits.map(c => c.commit.author.name));
    contributorsElement.textContent = uniqueAuthors.size;
  }
  
  // Update last updated
  const lastUpdatedElement = document.getElementById('last-updated');
  if (lastUpdatedElement && commits.length > 0) {
    const lastCommit = commits[0];
    const lastUpdate = new Date(lastCommit.commit.author.date);
    const timeAgo = formatTimeAgo(lastUpdate);
    lastUpdatedElement.textContent = timeAgo;
  }
  
  // Update hero section stats
  const heroRepos = document.getElementById('hero-repos');
  const heroCommits = document.getElementById('hero-commits');
  
  if (heroRepos) {
    heroRepos.textContent = repos.length;
  }
  
  if (heroCommits) {
    heroCommits.textContent = commits.length;
  }
}

function displayHomepageActivity(commits) {
  const activityList = document.getElementById('activity-list');
  
  if (commits.length === 0) {
    activityList.innerHTML = `
      <div class="p-5 text-center text-muted">
        <i class="fas fa-code-branch fa-3x mb-4"></i>
        <h4>No recent commits found</h4>
        <p>Check back later for updates or visit our GitHub organization directly.</p>
      </div>
    `;
    return;
  }
  
  const activityHTML = commits.slice(0, 8).map((commit, index) => {
    const commitDate = new Date(commit.commit.author.date);
    const timeAgo = formatTimeAgo(commitDate);
    const commitMessage = commit.commit.message.split('\n')[0]; // First line only
    const shortSha = commit.sha.substring(0, 7);
    
    return `
      <div class="d-flex align-items-start border-bottom border-gray-200 py-3 ${index === commits.length - 1 ? '' : 'border-bottom'}">
        <div class="flex-shrink-0 me-3">
          <div class="bg-primary bg-opacity-10 rounded-circle p-2">
            <i class="fas fa-code-branch text-primary"></i>
          </div>
        </div>
        <div class="flex-grow-1 min-width-0">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1 text-truncate">
                <a href="${commit.repository.html_url}" target="_blank" rel="noopener" class="text-decoration-none">
                  ${commit.repository.name}
                </a>
              </h6>
              <p class="mb-1 text-dark small">
                ${commitMessage}
              </p>
              <div class="d-flex align-items-center text-muted small">
                <span class="me-3">
                  <i class="fas fa-user me-1"></i>${commit.commit.author.name}
                </span>
                <span class="me-3">
                  <i class="fas fa-clock me-1"></i>${timeAgo}
                </span>
                <span class="badge bg-secondary bg-opacity-75 small">
                  <i class="fas fa-code me-1"></i>${shortSha}
                </span>
              </div>
            </div>
            <div class="ms-3">
              <a href="${commit.html_url}" class="btn btn-outline-primary btn-sm" target="_blank" rel="noopener">
                <i class="fas fa-external-link-alt"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  activityList.innerHTML = activityHTML;
}

function formatTimeAgo(date) {
  const now = new Date();
  const diffInSeconds = Math.floor((now - date) / 1000);
  
  if (diffInSeconds < 60) return 'just now';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
  if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
  
  return date.toLocaleDateString();
}
</script>
